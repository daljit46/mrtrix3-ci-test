find_program(BASH bash)

set(DATA_DIR ${CMAKE_CURRENT_SOURCE_DIR}/data)

# Add test that cleans up temporary files
add_test(
    NAME bintest_cleanup
    COMMAND ${BASH} -c "rm -rf ${DATA_DIR}/tmp* ${DATA_DIR}/*-tmp-*"
    WORKING_DIRECTORY ${DATA_DIR}
)
set_tests_properties(bintest_cleanup PROPERTIES FIXTURES_SETUP cleanup)

function(add_binary_tests file_path)
    get_filename_component(file_name ${file_path} NAME_WE)

    # Add a custom target for IDEs to pickup the test script
    add_custom_target(test_${file_name} SOURCES ${file_path})

    file(STRINGS ${file_path} FILE_CONTENTS)
    list(LENGTH FILE_CONTENTS FILE_CONTENTS_LENGTH)
    math(EXPR MAX_LINE_NUM "${FILE_CONTENTS_LENGTH} - 1")

    foreach(line_num RANGE ${MAX_LINE_NUM})
        list(GET FILE_CONTENTS ${line_num} line)

        set(test_name ${file_name})
        if(${FILE_CONTENTS_LENGTH} GREATER 1)
            math(EXPR suffix "${line_num} + 1")
            set(test_name "${file_name}_${suffix}")
        endif()

        set(EXEC_DIR1 ${CMAKE_CURRENT_BINARY_DIR})
        set(EXEC_DIR2 ${MRTRIX_MAIN_BINARY_DIR}/cmd)
        set(EXEC_DIR3 ${MRTRIX_MAIN_BINARY_DIR}/testing/cmd)

        add_test(
            NAME bintest_${test_name}
            COMMAND ${BASH} -c "export PATH=${EXEC_DIR1}:${EXEC_DIR2}:${EXEC_DIR3}:$PATH;${line}"
            WORKING_DIRECTORY ${DATA_DIR}
        )
        set_tests_properties(bintest_${test_name} 
            PROPERTIES FIXTURES_REQUIRED cleanup
        )
        message(VERBOSE "Add binary test command for ${file_name}: ${line}")
    endforeach()
endfunction()

add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/5tt2gmwmi)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/5tt2vis)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/5ttedit)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/amp2sh)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/connectomeedit)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dirgen)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dwi2adc)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dwi2fod)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dwi2tensor)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dwidenoise)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/dwiextract)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixel2peaks)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixel2sh)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixel2tsf)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixel2voxel)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelcfestats)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelconnectivity)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelcorrespondence)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelcrop)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelfilter)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fixelreorient)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fod2dec)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/fod2fixel)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/label2colour)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/label2mesh)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/labelconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/maskfilter)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mesh2voxel)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/meshconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrcalc)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrcat)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrclusterstats)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrcolour)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrdegibbs)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrfilter)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrgrid)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrhistmatch)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrhistogram)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrmath)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrregister)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrstats)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrthreshold)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mrtransform)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/mtnormalise)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/peaks2amp)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/peaks2fixel)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/sh2amp)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/sh2peaks)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/sh2power)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/sh2response)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/shbasis)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/shconv)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tck2connectome)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tckconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tckedit)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tckgen)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tckmap)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tckresample)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tcksample)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tcksift)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tcksift2)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tcktransform)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tensor2metric)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/transformcalc)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/transformcompose)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/transformconvert)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tsfdivide)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tsfmult)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tsfsmooth)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/tsfthreshold)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/vectorstats)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/voxel2fixel)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/warp2metric)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/warpcorrect)
add_binary_tests(${CMAKE_CURRENT_SOURCE_DIR}/tests/warpinit)
